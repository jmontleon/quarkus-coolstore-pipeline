---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
 name: deploy-coolstore-prereqs
spec:
  params:
  - name: GIT_REPO
    type: string
    default: "https://github.com/jmontleon/eap-coolstore-monolith"
  - name: GIT_REVISION
    type: string
    default: quarkus-migration
  - name: IMAGE_NAME
    type: string
    default: "quarkus-coolstore"
  - name: IMAGE_REGISTRY
    type: string
    default: "image-registry.openshift-image-registry.svc:5000"
  workspaces:
  - name: shared

  tasks:

  - name: deploy-coolstore-prereqs
    taskRef:
      name: openshift-client
      kind: ClusterTask
    params:
    - name: SCRIPT
      value: |
             oc -n $(context.pipelineRun.namespace) new-app --name postgres-kc --template postgresql-persistent -p POSTGRESQL_USER=admin -p POSTGRESQL_PASSWORD=keycloak -p POSTGRESQL_DATABASE=keycloak -p DATABASE_SERVICE_NAME=postgres-kc
             oc -n $(context.pipelineRun.namespace) new-app --name postgres --template postgresql-persistent -p POSTGRESQL_USER=cool -p POSTGRESQL_PASSWORD=cooldb -p POSTGRESQL_DATABASE=coolstore -p DATABASE_SERVICE_NAME=postgres
             cat << EOF | oc create -f -
             ---
             apiVersion: v1
             data:
               tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURmVENDQW1XZ0F3SUJBZ0lVT2Zxa3BWc2d3TzhIOW5hVncvOUlzUjhaYkFjd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1RqRW1NQ1FHQTFVRUF3d2RZWEJ3Y3k0dVlXa3ViV2xuY21GMGFXOXVMbkpsWkdoaGRDNWpiMjB4RnpBVgpCZ05WQkFvTURsUmxjM1FnUzJWNVkyeHZZV3N1TVFzd0NRWURWUVFHRXdKVlV6QWVGdzB5TkRBek1qQXhOVE01Ck1EZGFGdzB5TlRBek1qQXhOVE01TURkYU1FNHhKakFrQmdOVkJBTU1IV0Z3Y0hNdUxtRnBMbTFwWjNKaGRHbHYKYmk1eVpXUm9ZWFF1WTI5dE1SY3dGUVlEVlFRS0RBNVVaWE4wSUV0bGVXTnNiMkZyTGpFTE1Ba0dBMVVFQmhNQwpWVk13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRREdhZXQralluaTBUZ2ZjUHBuCjZIcnB3TDh0Q3pqbUY2RlRwZ1BGNDk2VnlBWVcwcWJGeXZqeW10eHRkREF6d1NJTmtITUVwOXJEdjZVRjJ4d2IKQVd0Sk5aNnBmKzRPUFNQdzlBQzl1VUxNVkhzaTRVU0VPY2x6ZTdIdXZkaWVKSUNvTzgwRmdKa2NTbC9NR0tXZQpqMnpnbGhSOVRlNHRDV3R0cklvdmtVa2VGZFhXNVZTZ3hQUTZ1b25FV3hvRXZCbVRmZDAwQllhWGlyanJOOGJJCmEzQU1NNGpFUXYwMDU4dHJWZFdESy9jM2E5Mnl0Njlwa1p2OHhxYzhvL0RZNXVPdXROSlZKdlJTUkM5OEhETUcKRlpCdzlVeklxU01WQ1hHOWl2V3VJL2UvZWVJSnVSZE9VdWFEbXhtUGxWcUtzZ0dKay9oeWZobUt2ZVpvbEhCQwpxSjI1QWdNQkFBR2pVekJSTUIwR0ExVWREZ1FXQkJRWlJia0xpN3RlMzVkdnNreU5vSjMxUEp4THB6QWZCZ05WCkhTTUVHREFXZ0JRWlJia0xpN3RlMzVkdnNreU5vSjMxUEp4THB6QVBCZ05WSFJNQkFmOEVCVEFEQVFIL01BMEcKQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUJwNDgzRzVrcnh1TTlkM2U5a1A5cjZxTHZVQThieW1FakdMSnNLcnFGRQprSTNuZ0dwd014a3Bua0Y0ZUJJblNRWnlJWVFVR0VDck5yVUxHWTVpck82Y2lrdEVYaDFaRXpQZEVCM2xGTVY0Ck9xdkdSbE9WUzlZODZtSFkrRkVZSWFZNmZzVTJvNjgwNUVuYzVLbExueWh6U0NHeG5NQ0o0L1YxWkVtajk1dkIKa0RMU3JEVjZ6eEhRSjI3Rmp3OGJrSTd3SjZGb1Q4ZFVZYW42UkxVK3lYSDBqOExJYldTbXpCSVN3Qk9naXY5TApab3ZpVDFheFpJcGxnTC9aWHpkV2xUWHlzYzZLeDJxTFlETFpIb2kyYkR2cFlQeitkRXpPV29oTmxmb0ZBa0JIClVXcnI5ZGp1NVhmeDYwODg1ckVhQWNFWXBCQ3VYcGdjTEZ4WG1RbmUyL2NOCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
               tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2d0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktrd2dnU2xBZ0VBQW9JQkFRREdhZXQralluaTBUZ2YKY1BwbjZIcnB3TDh0Q3pqbUY2RlRwZ1BGNDk2VnlBWVcwcWJGeXZqeW10eHRkREF6d1NJTmtITUVwOXJEdjZVRgoyeHdiQVd0Sk5aNnBmKzRPUFNQdzlBQzl1VUxNVkhzaTRVU0VPY2x6ZTdIdXZkaWVKSUNvTzgwRmdKa2NTbC9NCkdLV2VqMnpnbGhSOVRlNHRDV3R0cklvdmtVa2VGZFhXNVZTZ3hQUTZ1b25FV3hvRXZCbVRmZDAwQllhWGlyanIKTjhiSWEzQU1NNGpFUXYwMDU4dHJWZFdESy9jM2E5Mnl0Njlwa1p2OHhxYzhvL0RZNXVPdXROSlZKdlJTUkM5OApIRE1HRlpCdzlVeklxU01WQ1hHOWl2V3VJL2UvZWVJSnVSZE9VdWFEbXhtUGxWcUtzZ0dKay9oeWZobUt2ZVpvCmxIQkNxSjI1QWdNQkFBRUNnZ0VBR0pXNlJOR1Q0c05xMFZhRjZJY2haOEptemRXRXBOb0x0dG9zd0lIMkxCZi8KVFNlbjIzMUZjSVlveHZVdEhkU1IvQjFJYXl6RFNocitmeVhCcTBUM1ByaUNvdDBEcWNjQW81UVFYWEhOcVpUVQpOeU96Z2pESTJlTGJUc28rUTRZaFhQY2Y5YzBUNjdINWdjZ1NDWDRiRHc3NWxmY29pbk1PMlNXV2I4TndUR1pQCkZpcEdZZTdxYlJGNW52OXAvNE9KSGZxa3YwQklDUDFmZ0pXTFJOODJqdDFCQWptcEs2aUZxRFRzSjk3bjdRVXUKM2l6T1U1cnZ3WFV1VkkxOUEzNk10RCtEcDVFS3lMQllsMFVoZllOQ3A5R3dheUh3b0wzUXI1OHM3dEpTOGtJZwpQTTg2dTJtVk8ySzh0UjNPWmlRVEJNRTVSdThidzd5N1JPN3VKVVpHUVFLQmdRRDVyakhwcktFdXE4NTZhYy9MCjhJcmc0WjQzc253cEx3alYrYTB4ZTB1Q1QxTFRzejh4MGZJeERPdmt2ZWR4L09RbTZJSFp0OUlZcldXaWtva28KWloraGQ2NGZFTTduQ3JxcTk4ZnV6eDZIcmZwRlkyRUhhMXIrV3dudGpmeUFMdUViUmZMMW14ZThKQW9EQmYwdAp2L2VvcUZLUXd4bUtVY2dscnowektYTDQwUUtCZ1FETGI0clAxK1pKVFdwOFVqeDE4ZGcwd1BNL2ZuSTdibXZWCnZGOXFCUmNlblhnSU11NDRBeDNwNmxIb0s3VHAvRCt1dlZ1NldWdnA0V2ZOaFFWZ0Zqclk1VkpsTFRiTUxEZHUKM3drcVUvblp0VFdBSklCL2szbEpMTEhvNW1oaWVNOE1EeDYvWG1NU1lqZEJFY3hsV1lXZHlKUlV0OEFtUjdhLwo1aTNUOEp1UWFRS0JnUUNSaW1MNTdYRC9QWkxjZEhWMlViOENtMEdaQWVleU1nS2FpREhXMkNJSjBhZGNVKzRRClltc2xBSDA1RnlHa3BsOXY5clJLYndaKzhBU0FvWjVsOStiM1BrWTNRWnI1dnAxVkw1NVJyRllGalBxSUhBZmgKUlVrRFg1b0g2VzQ0WWh0QnhLSjlYR3lYZFFLSkJLS3lXbVpJMytWUkVRa0FRZS9EVjhUNjM3eHZJUUtCZ1FDNApUSGpKQ3FMSnphU210Q21xQUVzS243SysxdUxPREo4TXB2Y1pxVHJrdFd2RW9iOUdaeXgyZVoxeVpBWWw1Q3dkCk5kY2YzMHh4ZVk3OGxZSGxKcjV4T0crSTBZbFBOcytSVmVXTHYwQWVoeGZNMjBTK1R2QVY1clBXZHNZaVQ2ZmoKR04rV0p3QkI2MUI3VnBDQlVMVEgyS3JvaFA5Q3JyMVU1RWFvTnRYMzRRS0JnUURUL2QvMUZjSG94ZVhHdkJJVgozL3dLcm1qVERXQmltcTlhbTAxc0VEVEVkUW1LM3ZLUnFMSUpKd2dyZThvS05WaHJUMGpza2xiR1E1dWd1MTRYCk4rMDUybGdIdG83TytzU3Mvcm05clBDV0NFRGtRaU4yckhhNVB4NW56WTBBaXFlVVUxUGY4SDdaMU4zM0U0SFQKdjlHQjNGdlRWSzNaRjY2VXFxQkNRd0t3MkE9PQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tCg==
             kind: Secret
             metadata:
               name: keycloak-tls
               namespace: $(context.pipelineRun.namespace)
             type: kubernetes.io/tls
             ---
             apiVersion: operators.coreos.com/v1alpha1
             kind: Subscription
             metadata:
               name: keycloak-operator
               namespace: $(context.pipelineRun.namespace)
             spec:
               channel: fast
               installPlanApproval: Automatic
               name: keycloak-operator
               source: community-operators
               sourceNamespace: openshift-marketplace
               startingCSV: keycloak-operator.v24.0.1
             ---
             apiVersion: operators.coreos.com/v1alpha1
             kind: Subscription
             metadata:
               name: rabbitmq-cluster-operator
               namespace: $(context.pipelineRun.namespace)
             spec:
               channel: stable
               installPlanApproval: Automatic
               name: rabbitmq-cluster-operator
               source: community-operators
               sourceNamespace: openshift-marketplace
               startingCSV: rabbitmq-cluster-operator.v2.7.0
             ---
             apiVersion: rabbitmq.com/v1beta1
             kind: RabbitmqCluster
             metadata:
               name: rabbitmq
               namespace: $(context.pipelineRun.namespace)
             spec:
               delayStartSeconds: 30
               image: rabbitmq:3.12.2-management
               override: {}
               persistence:
                 storage: 10Gi
               rabbitmq:
                 additionalPlugins:
                 - rabbitmq_amqp1_0
               replicas: 1
               resources:
                 limits:
                   cpu: "2"
                   memory: 2Gi
                 requests:
                   cpu: "1"
                   memory: 2Gi
               secretBackend:
                 externalSecret: {}
               service:
                 type: ClusterIP
               terminationGracePeriodSeconds: 604800
               tls: {}
             ---
             apiVersion: k8s.keycloak.org/v2alpha1
             kind: Keycloak
             metadata:
               name: keycloak
               namespace: $(context.pipelineRun.namespace)
             spec:
               db:
                 host: postgres-kc
                 passwordSecret:
                   key: database-password
                   name: postgres-kc
                 usernameSecret:
                   key: database-user
                   name: postgres-kc
                 vendor: postgres
               http:
                 httpEnabled: true
                 tlsSecret: keycloak-tls
               ingress:
                 className: openshift-default
               instances: 1
             EOF
             until oc get pod keycloak-0; do sleep 1; done
             oc delete po keycloak-0
             until oc get pod keycloak-0; do sleep 1; done
             oc wait --for=condition=ready pod keycloak-0 -n $(context.pipelineRun.namespace) --timeout=600s
             cat << EOF | oc create -f -
             apiVersion: k8s.keycloak.org/v2alpha1
             kind: KeycloakRealmImport
             metadata:
               name: quarkus-import
             spec:
               keycloakCRName: keycloak
               realm:
                 id: c054a229-bcd8-458b-81a4-27e333bee6e4
                 realm: quarkus
                 notBefore: 0
                 defaultSignatureAlgorithm: RS256
                 revokeRefreshToken: false
                 refreshTokenMaxReuse: 0
                 accessTokenLifespan: 300
                 accessTokenLifespanForImplicitFlow: 900
                 ssoSessionIdleTimeout: 1800
                 ssoSessionMaxLifespan: 36000
                 ssoSessionIdleTimeoutRememberMe: 0
                 ssoSessionMaxLifespanRememberMe: 0
                 offlineSessionIdleTimeout: 2592000
                 offlineSessionMaxLifespanEnabled: false
                 offlineSessionMaxLifespan: 5184000
                 clientSessionIdleTimeout: 0
                 clientSessionMaxLifespan: 0
                 clientOfflineSessionIdleTimeout: 0
                 clientOfflineSessionMaxLifespan: 0
                 accessCodeLifespan: 60
                 accessCodeLifespanUserAction: 300
                 accessCodeLifespanLogin: 1800
                 actionTokenGeneratedByAdminLifespan: 43200
                 actionTokenGeneratedByUserLifespan: 300
                 oauth2DeviceCodeLifespan: 600
                 oauth2DevicePollingInterval: 5
                 enabled: true
                 sslRequired: external
                 registrationAllowed: false
                 registrationEmailAsUsername: false
                 rememberMe: false
                 verifyEmail: false
                 loginWithEmailAllowed: true
                 duplicateEmailsAllowed: false
                 resetPasswordAllowed: false
                 editUsernameAllowed: false
                 bruteForceProtected: false
                 permanentLockout: false
                 maxFailureWaitSeconds: 900
                 minimumQuickLoginWaitSeconds: 60
                 waitIncrementSeconds: 60
                 quickLoginCheckMilliSeconds: 1000
                 maxDeltaTimeSeconds: 43200
                 failureFactor: 30
                 defaultRole:
                   id: 0770c39d-0f6b-4600-9307-fdbb0bf49cf8
                   name: default-roles-eap
                   description: ${role_default-roles}
                   composite: true
                   clientRole: false
                   containerId: c054a229-bcd8-458b-81a4-27e333bee6e4
                 requiredCredentials:
                   - password
                 otpPolicyType: totp
                 otpPolicyAlgorithm: HmacSHA1
                 otpPolicyInitialCounter: 0
                 otpPolicyDigits: 6
                 otpPolicyLookAheadWindow: 1
                 otpPolicyPeriod: 30
                 otpPolicyCodeReusable: false
                 otpSupportedApplications:
                   - totpAppGoogleName
                   - totpAppFreeOTPName
                 webAuthnPolicyRpEntityName: keycloak
                 webAuthnPolicySignatureAlgorithms:
                   - ES256
                 webAuthnPolicyRpId: ""
                 webAuthnPolicyAttestationConveyancePreference: not specified
                 webAuthnPolicyAuthenticatorAttachment: not specified
                 webAuthnPolicyRequireResidentKey: not specified
                 webAuthnPolicyUserVerificationRequirement: not specified
                 webAuthnPolicyCreateTimeout: 0
                 webAuthnPolicyAvoidSameAuthenticatorRegister: false
                 webAuthnPolicyAcceptableAaguids: []
                 webAuthnPolicyPasswordlessRpEntityName: keycloak
                 webAuthnPolicyPasswordlessSignatureAlgorithms:
                   - ES256
                 webAuthnPolicyPasswordlessRpId: ""
                 webAuthnPolicyPasswordlessAttestationConveyancePreference: not specified
                 webAuthnPolicyPasswordlessAuthenticatorAttachment: not specified
                 webAuthnPolicyPasswordlessRequireResidentKey: not specified
                 webAuthnPolicyPasswordlessUserVerificationRequirement: not specified
                 webAuthnPolicyPasswordlessCreateTimeout: 0
                 webAuthnPolicyPasswordlessAvoidSameAuthenticatorRegister: false
                 webAuthnPolicyPasswordlessAcceptableAaguids: []
                 scopeMappings:
                   - clientScope: offline_access
                     roles:
                       - offline_access
                 clientScopeMappings:
                   account:
                     - client: account-console
                       roles:
                         - manage-account
                         - view-groups
                 clients:
                   - id: e9c6c371-2ecc-4e0c-9692-5d9a430de0e1
                     clientId: account
                     name: ${client_account}
                     rootUrl: ${authBaseUrl}
                     baseUrl: /realms/eap/account/
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris:
                       - /realms/eap/account/*
                     webOrigins: []
                     notBefore: 0
                     bearerOnly: false
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: false
                     serviceAccountsEnabled: false
                     publicClient: true
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes:
                       post.logout.redirect.uris: +
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: be75b005-7b27-4c40-a271-b42556f0ab01
                     clientId: account-console
                     name: ${client_account-console}
                     description: ""
                     rootUrl: ${authBaseUrl}
                     adminUrl: ""
                     baseUrl: /realms/eap/account/
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris:
                       - /realms/eap/account/*
                     webOrigins:
                       - '*'
                     notBefore: 0
                     bearerOnly: false
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: false
                     serviceAccountsEnabled: false
                     publicClient: true
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes:
                       oidc.ciba.grant.enabled: "false"
                       backchannel.logout.session.required: "true"
                       post.logout.redirect.uris: +
                       oauth2.device.authorization.grant.enabled: "false"
                       display.on.consent.screen: "false"
                       pkce.code.challenge.method: S256
                       backchannel.logout.revoke.offline.tokens: "false"
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     protocolMappers:
                       - id: 348b3fbe-95dd-42ad-a6ac-66f1e2ddba8c
                         name: audience resolve
                         protocol: openid-connect
                         protocolMapper: oidc-audience-resolve-mapper
                         consentRequired: false
                         config: {}
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: 4bb4c0c7-9f37-4616-9cf8-5cca0b4523fd
                     clientId: admin-cli
                     name: ${client_admin-cli}
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris: []
                     webOrigins: []
                     notBefore: 0
                     bearerOnly: false
                     consentRequired: false
                     standardFlowEnabled: false
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: true
                     serviceAccountsEnabled: false
                     publicClient: true
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes: {}
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: 92f3824a-db66-44b3-9012-e6dcf8cc5cb3
                     clientId: broker
                     name: ${client_broker}
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris: []
                     webOrigins: []
                     notBefore: 0
                     bearerOnly: true
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: false
                     serviceAccountsEnabled: false
                     publicClient: false
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes: {}
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: 24ce7951-ec39-490f-bc36-91bff17c13aa
                     clientId: ui
                     name: ""
                     description: ""
                     rootUrl: ""
                     adminUrl: ""
                     baseUrl: ""
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris:
                       - ""
                       - '*'
                     webOrigins:
                       - '*'
                     notBefore: 0
                     bearerOnly: false
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: true
                     directAccessGrantsEnabled: true
                     serviceAccountsEnabled: false
                     publicClient: true
                     frontchannelLogout: true
                     protocol: openid-connect
                     attributes:
                       client.secret.creation.time: "1677078233"
                       post.logout.redirect.uris: '*'
                       oauth2.device.authorization.grant.enabled: "false"
                       backchannel.logout.revoke.offline.tokens: "false"
                       use.refresh.tokens: "true"
                       tls-client-certificate-bound-access-tokens: "false"
                       oidc.ciba.grant.enabled: "false"
                       backchannel.logout.session.required: "true"
                       client_credentials.use_refresh_token: "false"
                       acr.loa.map: '{}'
                       require.pushed.authorization.requests: "false"
                       display.on.consent.screen: "false"
                       token.response.type.bearer.lower-case: "false"
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: true
                     nodeReRegistrationTimeout: -1
                     protocolMappers:
                       - id: 7cc9bd92-754d-4764-9565-128bcdcd7daa
                         name: Client Host
                         protocol: openid-connect
                         protocolMapper: oidc-usersessionmodel-note-mapper
                         consentRequired: false
                         config:
                           user.session.note: clientHost
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: clientHost
                           jsonType.label: String
                       - id: 2dad55b4-fe76-4b8f-9e8c-038227a5cb4d
                         name: Client ID
                         protocol: openid-connect
                         protocolMapper: oidc-usersessionmodel-note-mapper
                         consentRequired: false
                         config:
                           user.session.note: clientId
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: clientId
                           jsonType.label: String
                       - id: fb2653ce-cc37-4770-aa81-d339d6100099
                         name: Client IP Address
                         protocol: openid-connect
                         protocolMapper: oidc-usersessionmodel-note-mapper
                         consentRequired: false
                         config:
                           user.session.note: clientAddress
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: clientAddress
                           jsonType.label: String
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: 3f83324f-813c-41f1-ab90-70276d3fafa1
                     clientId: realm-management
                     name: ${client_realm-management}
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris: []
                     webOrigins: []
                     notBefore: 0
                     bearerOnly: true
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: false
                     serviceAccountsEnabled: false
                     publicClient: false
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes: {}
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                   - id: d00da663-ef26-4673-a5d6-06011c396d00
                     clientId: security-admin-console
                     name: ${client_security-admin-console}
                     rootUrl: ${authAdminUrl}
                     baseUrl: /admin/eap/console/
                     surrogateAuthRequired: false
                     enabled: true
                     alwaysDisplayInConsole: false
                     clientAuthenticatorType: client-secret
                     redirectUris:
                       - /admin/eap/console/*
                     webOrigins:
                       - +
                     notBefore: 0
                     bearerOnly: false
                     consentRequired: false
                     standardFlowEnabled: true
                     implicitFlowEnabled: false
                     directAccessGrantsEnabled: false
                     serviceAccountsEnabled: false
                     publicClient: true
                     frontchannelLogout: false
                     protocol: openid-connect
                     attributes:
                       post.logout.redirect.uris: +
                       pkce.code.challenge.method: S256
                     authenticationFlowBindingOverrides: {}
                     fullScopeAllowed: false
                     nodeReRegistrationTimeout: 0
                     protocolMappers:
                       - id: 9da678f5-0ba4-40dd-a2c0-7579ee8fdc7e
                         name: locale
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: locale
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: locale
                           jsonType.label: String
                     defaultClientScopes:
                       - web-origins
                       - acr
                       - roles
                       - profile
                       - email
                     optionalClientScopes:
                       - address
                       - phone
                       - offline_access
                       - microprofile-jwt
                 clientScopes:
                   - id: 03566133-1ef1-45c6-9255-c0524caf82f9
                     name: role_list
                     description: SAML role list
                     protocol: saml
                     attributes:
                       consent.screen.text: ${samlRoleListScopeConsentText}
                       display.on.consent.screen: "true"
                     protocolMappers:
                       - id: 25d2d3d3-c7e5-4978-876b-b33f17b309eb
                         name: role list
                         protocol: saml
                         protocolMapper: saml-role-list-mapper
                         consentRequired: false
                         config:
                           single: "false"
                           attribute.nameformat: Basic
                           attribute.name: Role
                   - id: 767d594d-f576-4ee2-81a7-16ac1cca5fbf
                     name: address
                     description: 'OpenID Connect built-in scope: address'
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "true"
                       display.on.consent.screen: "true"
                       consent.screen.text: ${addressScopeConsentText}
                     protocolMappers:
                       - id: 18c460f7-c503-42ec-a18e-3dd240d7ed3b
                         name: address
                         protocol: openid-connect
                         protocolMapper: oidc-address-mapper
                         consentRequired: false
                         config:
                           user.attribute.formatted: formatted
                           user.attribute.country: country
                           user.attribute.postal_code: postal_code
                           userinfo.token.claim: "true"
                           user.attribute.street: street
                           id.token.claim: "true"
                           user.attribute.region: region
                           access.token.claim: "true"
                           user.attribute.locality: locality
                   - id: f77ec6ad-40ee-46f0-a74a-0c4026a62211
                     name: phone
                     description: 'OpenID Connect built-in scope: phone'
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "true"
                       display.on.consent.screen: "true"
                       consent.screen.text: ${phoneScopeConsentText}
                     protocolMappers:
                       - id: 2cba7d5f-4425-48b7-963a-3eb5ac28e8ba
                         name: phone number verified
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: phoneNumberVerified
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: phone_number_verified
                           jsonType.label: boolean
                       - id: d20fd766-f4ec-4659-9523-1a75e3331503
                         name: phone number
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: phoneNumber
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: phone_number
                           jsonType.label: String
                   - id: 6d7f09d9-7979-46bd-a5af-ad73e58f11c8
                     name: roles
                     description: OpenID Connect scope for add user roles to the access token
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "false"
                       display.on.consent.screen: "true"
                       consent.screen.text: ${rolesScopeConsentText}
                     protocolMappers:
                       - id: acd34eb2-e2a7-45bb-8326-779ec0a9ded4
                         name: audience resolve
                         protocol: openid-connect
                         protocolMapper: oidc-audience-resolve-mapper
                         consentRequired: false
                         config: {}
                       - id: 6b4ae73f-b6ca-4fdc-a8bb-57de8e26340a
                         name: client roles
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-client-role-mapper
                         consentRequired: false
                         config:
                           user.attribute: foo
                           access.token.claim: "true"
                           claim.name: resource_access.${client_id}.roles
                           jsonType.label: String
                           multivalued: "true"
                       - id: 0503c6a2-b1b1-47c4-bdd5-2beed11b4d6d
                         name: realm roles
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-realm-role-mapper
                         consentRequired: false
                         config:
                           user.attribute: foo
                           access.token.claim: "true"
                           claim.name: realm_access.roles
                           jsonType.label: String
                           multivalued: "true"
                   - id: 505ff63c-29a3-4bad-ae87-0634d3d5cfc4
                     name: profile
                     description: 'OpenID Connect built-in scope: profile'
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "true"
                       display.on.consent.screen: "true"
                       consent.screen.text: ${profileScopeConsentText}
                     protocolMappers:
                       - id: 8a3c9dcb-a6e9-43e7-8cdf-d753b9220fb9
                         name: gender
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: gender
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: gender
                           jsonType.label: String
                       - id: 906714bc-682b-47ce-a170-3098d0f9b2d8
                         name: updated at
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: updatedAt
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: updated_at
                           jsonType.label: long
                       - id: 2e8ea554-8436-45b3-bbff-197a6821f2f0
                         name: locale
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: locale
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: locale
                           jsonType.label: String
                       - id: d7b09b38-bf20-472a-a926-e6c774dffd00
                         name: family name
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: lastName
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: family_name
                           jsonType.label: String
                       - id: 00a6b70e-2e43-4382-877a-abbde23c6fd0
                         name: zoneinfo
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: zoneinfo
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: zoneinfo
                           jsonType.label: String
                       - id: 621002ea-e65d-42dc-9fb7-87dba3690542
                         name: username
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: username
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: preferred_username
                           jsonType.label: String
                       - id: 6ca0c332-c463-4a87-904b-3f9fde4ae63b
                         name: website
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: website
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: website
                           jsonType.label: String
                       - id: f29a3264-f585-4a2e-907e-eedfbaffb0a8
                         name: nickname
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: nickname
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: nickname
                           jsonType.label: String
                       - id: 19c792b4-fc00-4899-8d4a-d011c34a17f0
                         name: profile
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: profile
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: profile
                           jsonType.label: String
                       - id: e2a8fa65-ac41-4d7d-abd6-2504428428df
                         name: full name
                         protocol: openid-connect
                         protocolMapper: oidc-full-name-mapper
                         consentRequired: false
                         config:
                           id.token.claim: "true"
                           access.token.claim: "true"
                           userinfo.token.claim: "true"
                       - id: 150168bc-744b-4478-b8d6-e713efc1b406
                         name: middle name
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: middleName
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: middle_name
                           jsonType.label: String
                       - id: 05954453-866f-43e6-a030-8dad14f06c4c
                         name: birthdate
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: birthdate
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: birthdate
                           jsonType.label: String
                       - id: 8a5acd0c-a4dd-41f8-b202-856f87423c7a
                         name: given name
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: firstName
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: given_name
                           jsonType.label: String
                       - id: 55547d20-c088-458e-9c33-5a3c992b7636
                         name: picture
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-attribute-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: picture
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: picture
                           jsonType.label: String
                   - id: d39f5398-3e12-4b27-9797-b566c608aade
                     name: microprofile-jwt
                     description: Microprofile - JWT built-in scope
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "true"
                       display.on.consent.screen: "false"
                     protocolMappers:
                       - id: 2b62eea1-37ad-4bb8-8552-a6731635cadf
                         name: groups
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-realm-role-mapper
                         consentRequired: false
                         config:
                           multivalued: "true"
                           user.attribute: foo
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: groups
                           jsonType.label: String
                       - id: d1987076-82d1-4964-8b77-81350e299b70
                         name: upn
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: username
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: upn
                           jsonType.label: String
                   - id: b6e369a9-3f15-476c-bf52-36e6099c5a78
                     name: web-origins
                     description: OpenID Connect scope for add allowed web origins to the access token
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "false"
                       display.on.consent.screen: "false"
                       consent.screen.text: ""
                     protocolMappers:
                       - id: 1b6a4769-7b34-483d-b592-67ff27a03d78
                         name: allowed web origins
                         protocol: openid-connect
                         protocolMapper: oidc-allowed-origins-mapper
                         consentRequired: false
                         config: {}
                   - id: dd30154e-2e9e-49c7-a3c4-0406dcbece10
                     name: offline_access
                     description: 'OpenID Connect built-in scope: offline_access'
                     protocol: openid-connect
                     attributes:
                       consent.screen.text: ${offlineAccessScopeConsentText}
                       display.on.consent.screen: "true"
                   - id: 25f485af-de62-4c1b-ae0d-63c928776d93
                     name: email
                     description: 'OpenID Connect built-in scope: email'
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "true"
                       display.on.consent.screen: "true"
                       consent.screen.text: ${emailScopeConsentText}
                     protocolMappers:
                       - id: 8d0bcaee-86cc-442f-b021-3a961df72428
                         name: email
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: email
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: email
                           jsonType.label: String
                       - id: 4ed5c341-9d2a-483d-b7e3-2e1aa62d5d20
                         name: email verified
                         protocol: openid-connect
                         protocolMapper: oidc-usermodel-property-mapper
                         consentRequired: false
                         config:
                           userinfo.token.claim: "true"
                           user.attribute: emailVerified
                           id.token.claim: "true"
                           access.token.claim: "true"
                           claim.name: email_verified
                           jsonType.label: boolean
                   - id: 34f5a6c0-a71b-4fc7-96d8-38a9800dd5a2
                     name: acr
                     description: OpenID Connect scope for add acr (authentication context class reference) to the token
                     protocol: openid-connect
                     attributes:
                       include.in.token.scope: "false"
                       display.on.consent.screen: "false"
                     protocolMappers:
                       - id: b9b03f0d-41eb-4763-af2e-2fd7e123a179
                         name: acr loa level
                         protocol: openid-connect
                         protocolMapper: oidc-acr-mapper
                         consentRequired: false
                         config:
                           id.token.claim: "true"
                           access.token.claim: "true"
                 defaultDefaultClientScopes:
                   - role_list
                   - profile
                   - email
                   - roles
                   - web-origins
                   - acr
                 defaultOptionalClientScopes:
                   - offline_access
                   - address
                   - phone
                   - microprofile-jwt
                 browserSecurityHeaders:
                   contentSecurityPolicyReportOnly: ""
                   xContentTypeOptions: nosniff
                   xRobotsTag: none
                   xFrameOptions: SAMEORIGIN
                   contentSecurityPolicy: frame-src 'self'; frame-ancestors 'self'; object-src 'none';
                   xXSSProtection: 1; mode=block
                   strictTransportSecurity: max-age=31536000; includeSubDomains
                 smtpServer: {}
                 eventsEnabled: true
                 eventsListeners:
                   - jboss-logging
                   - email
                 enabledEventTypes: []
                 adminEventsEnabled: true
                 adminEventsDetailsEnabled: false
                 identityProviders: []
                 identityProviderMappers: []
                 components:
                   org.keycloak.services.clientregistration.policy.ClientRegistrationPolicy:
                     - id: 093ce19c-21c6-426b-a5f9-c84485d49178
                       name: Allowed Client Scopes
                       providerId: allowed-client-templates
                       subType: anonymous
                       subComponents: {}
                       config:
                         allow-default-scopes:
                           - "true"
                     - id: 0b83a8d8-463b-43b8-8478-8ef254e4b0da
                       name: Max Clients Limit
                       providerId: max-clients
                       subType: anonymous
                       subComponents: {}
                       config:
                         max-clients:
                           - "200"
                     - id: 4cf73054-b4fb-4c69-9447-aa13412e5f0a
                       name: Allowed Client Scopes
                       providerId: allowed-client-templates
                       subType: authenticated
                       subComponents: {}
                       config:
                         allow-default-scopes:
                           - "true"
                     - id: af1ab818-4eae-4687-ae50-074f9720e125
                       name: Trusted Hosts
                       providerId: trusted-hosts
                       subType: anonymous
                       subComponents: {}
                       config:
                         host-sending-registration-request-must-match:
                           - "true"
                         client-uris-must-match:
                           - "true"
                     - id: ace7c238-9e25-4aaa-be33-e4b09667d814
                       name: Full Scope Disabled
                       providerId: scope
                       subType: anonymous
                       subComponents: {}
                       config: {}
                     - id: 6b75f739-af82-4c60-a89e-391d41d00fab
                       name: Allowed Protocol Mapper Types
                       providerId: allowed-protocol-mappers
                       subType: authenticated
                       subComponents: {}
                       config:
                         allowed-protocol-mapper-types:
                           - oidc-usermodel-attribute-mapper
                           - saml-user-attribute-mapper
                           - oidc-full-name-mapper
                           - saml-role-list-mapper
                           - oidc-usermodel-property-mapper
                           - oidc-sha256-pairwise-sub-mapper
                           - saml-user-property-mapper
                           - oidc-address-mapper
                     - id: 0e4c21eb-8b14-4c2a-82f0-43f4d84d6c28
                       name: Allowed Protocol Mapper Types
                       providerId: allowed-protocol-mappers
                       subType: anonymous
                       subComponents: {}
                       config:
                         allowed-protocol-mapper-types:
                           - saml-user-attribute-mapper
                           - saml-role-list-mapper
                           - oidc-sha256-pairwise-sub-mapper
                           - oidc-usermodel-attribute-mapper
                           - saml-user-property-mapper
                           - oidc-usermodel-property-mapper
                           - oidc-address-mapper
                           - oidc-full-name-mapper
                     - id: 4690dd35-844b-4ffb-9d0a-a428a2836422
                       name: Consent Required
                       providerId: consent-required
                       subType: anonymous
                       subComponents: {}
                       config: {}
                   org.keycloak.userprofile.UserProfileProvider:
                     - id: ea694b6d-6c63-4930-b91d-f161e5d7cbc1
                       providerId: declarative-user-profile
                       subComponents: {}
                       config: {}
                   org.keycloak.keys.KeyProvider:
                     - id: 2c575d1c-e6be-4c2b-bb29-7c2b103485bc
                       name: aes-generated
                       providerId: aes-generated
                       subComponents: {}
                       config:
                         priority:
                           - "100"
                     - id: 79ea65a7-2201-4696-abc6-b408296be0a8
                       name: rsa-enc-generated
                       providerId: rsa-enc-generated
                       subComponents: {}
                       config:
                         priority:
                           - "100"
                         algorithm:
                           - RSA-OAEP
                     - id: bcfdaaa6-ae08-4b57-b48e-b515ff67d8bf
                       name: rsa-generated
                       providerId: rsa-generated
                       subComponents: {}
                       config:
                         priority:
                           - "100"
                     - id: 06fe5315-4f03-4094-baf0-d57baf78e7ef
                       name: hmac-generated
                       providerId: hmac-generated
                       subComponents: {}
                       config:
                         priority:
                           - "100"
                         algorithm:
                           - HS256
                 internationalizationEnabled: false
                 supportedLocales: []
                 authenticationFlows:
                   - id: 7faf55af-5f7c-4c07-952c-a76afd0da6b9
                     alias: Account verification options
                     description: Method with which to verity the existing account
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: idp-email-verification
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: ALTERNATIVE
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: Verify Existing Account by Re-authentication
                         userSetupAllowed: false
                   - id: 952b6c15-b0d9-4377-b480-7c86ab5d11f5
                     alias: Authentication Options
                     description: Authentication options.
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: basic-auth
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: basic-auth-otp
                         authenticatorFlow: false
                         requirement: DISABLED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: auth-spnego
                         authenticatorFlow: false
                         requirement: DISABLED
                         priority: 30
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: 768c5acd-5c26-4ad4-af9d-b82b0aa44222
                     alias: Browser - Conditional OTP
                     description: Flow to determine if the OTP is required for the authentication
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: conditional-user-configured
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: auth-otp-form
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: 5a4b7625-eab0-48f3-a779-7008cf635e5c
                     alias: Direct Grant - Conditional OTP
                     description: Flow to determine if the OTP is required for the authentication
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: conditional-user-configured
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: direct-grant-validate-otp
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: d7ea76c1-6254-4fe7-8637-c1f955231a8c
                     alias: First broker login - Conditional OTP
                     description: Flow to determine if the OTP is required for the authentication
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: conditional-user-configured
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: auth-otp-form
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: e5196154-ecd7-4aeb-acf2-f92b2c2764fd
                     alias: Handle Existing Account
                     description: Handle what to do if there is existing account with same email/username like authenticated identity provider
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: idp-confirm-link
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: Account verification options
                         userSetupAllowed: false
                   - id: 94d29a2e-5fd9-4820-ad7f-0f95a7d23fae
                     alias: Reset - Conditional OTP
                     description: Flow to determine if the OTP should be reset or not. Set to REQUIRED to force.
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: conditional-user-configured
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: reset-otp
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: f8d0d697-639b-4d2d-adae-720d81023d38
                     alias: User creation or linking
                     description: Flow for the existing/non-existing user alternatives
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticatorConfig: create unique user config
                         authenticator: idp-create-user-if-unique
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: ALTERNATIVE
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: Handle Existing Account
                         userSetupAllowed: false
                   - id: b284838e-93b4-4af1-8bfc-83f4e8028c70
                     alias: Verify Existing Account by Re-authentication
                     description: Reauthentication of existing account
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: idp-username-password-form
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: CONDITIONAL
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: First broker login - Conditional OTP
                         userSetupAllowed: false
                   - id: bfbd3de0-1f8d-4132-8c4d-136bdf44417b
                     alias: browser
                     description: browser based authentication
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: auth-cookie
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: auth-spnego
                         authenticatorFlow: false
                         requirement: DISABLED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: identity-provider-redirector
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 25
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: ALTERNATIVE
                         priority: 30
                         autheticatorFlow: true
                         flowAlias: forms
                         userSetupAllowed: false
                   - id: 6ae0104d-afe4-4a64-88fa-0f90777cb7fe
                     alias: clients
                     description: Base authentication for clients
                     providerId: client-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: client-secret
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: client-jwt
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: client-secret-jwt
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 30
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: client-x509
                         authenticatorFlow: false
                         requirement: ALTERNATIVE
                         priority: 40
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: b66777e8-d98c-423f-9c85-5c7755727c39
                     alias: direct grant
                     description: OpenID Connect Resource Owner Grant
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: direct-grant-validate-username
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: direct-grant-validate-password
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: CONDITIONAL
                         priority: 30
                         autheticatorFlow: true
                         flowAlias: Direct Grant - Conditional OTP
                         userSetupAllowed: false
                   - id: 9faa3b08-1bd2-43f7-86c4-e4592069d1f9
                     alias: docker auth
                     description: Used by Docker clients to authenticate against the IDP
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: docker-http-basic-authenticator
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: c1755813-4198-4329-a76b-6a4889b2bd9a
                     alias: first broker login
                     description: Actions taken after first broker login with identity provider account, which is not yet linked to any Keycloak account
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticatorConfig: review profile config
                         authenticator: idp-review-profile
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: User creation or linking
                         userSetupAllowed: false
                   - id: 352f276a-3ab0-4b7c-adb6-8dcf39fafb6d
                     alias: forms
                     description: Username, password, otp and other auth forms.
                     providerId: basic-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: auth-username-password-form
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: CONDITIONAL
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: Browser - Conditional OTP
                         userSetupAllowed: false
                   - id: 95651538-94ac-4fdc-8bfd-2b021bed110e
                     alias: http challenge
                     description: An authentication flow based on challenge-response HTTP Authentication Schemes
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: no-cookie-redirect
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: true
                         flowAlias: Authentication Options
                         userSetupAllowed: false
                   - id: 6347d82e-c305-4f4d-b2a4-fbdf4ccd840a
                     alias: registration
                     description: registration flow
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: registration-page-form
                         authenticatorFlow: true
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: true
                         flowAlias: registration form
                         userSetupAllowed: false
                   - id: f4191e88-8b0d-4b9c-a00d-3f540f0f0a4d
                     alias: registration form
                     description: registration form
                     providerId: form-flow
                     topLevel: false
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: registration-user-creation
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: registration-profile-action
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 40
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: registration-password-action
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 50
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: registration-recaptcha-action
                         authenticatorFlow: false
                         requirement: DISABLED
                         priority: 60
                         autheticatorFlow: false
                         userSetupAllowed: false
                   - id: 9f2fa0a3-2e6b-4ddf-9835-421dce872114
                     alias: reset credentials
                     description: Reset credentials for a user if they forgot their password or something
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: reset-credentials-choose-user
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: reset-credential-email
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 20
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticator: reset-password
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 30
                         autheticatorFlow: false
                         userSetupAllowed: false
                       - authenticatorFlow: true
                         requirement: CONDITIONAL
                         priority: 40
                         autheticatorFlow: true
                         flowAlias: Reset - Conditional OTP
                         userSetupAllowed: false
                   - id: 6e22b6da-5940-4f2f-a978-9f33f6676109
                     alias: saml ecp
                     description: SAML ECP Profile Authentication Flow
                     providerId: basic-flow
                     topLevel: true
                     builtIn: true
                     authenticationExecutions:
                       - authenticator: http-basic-authenticator
                         authenticatorFlow: false
                         requirement: REQUIRED
                         priority: 10
                         autheticatorFlow: false
                         userSetupAllowed: false
                 authenticatorConfig:
                   - id: a440ef67-5bba-4728-9a93-6c770d455eb4
                     alias: create unique user config
                     config:
                       require.password.update.after.registration: "false"
                   - id: 223200e2-10e9-4aad-b208-4f9a84cc4371
                     alias: review profile config
                     config:
                       update.profile.on.first.login: missing
                 requiredActions:
                   - alias: CONFIGURE_TOTP
                     name: Configure OTP
                     providerId: CONFIGURE_TOTP
                     enabled: true
                     defaultAction: false
                     priority: 10
                     config: {}
                   - alias: terms_and_conditions
                     name: Terms and Conditions
                     providerId: terms_and_conditions
                     enabled: false
                     defaultAction: false
                     priority: 20
                     config: {}
                   - alias: UPDATE_PASSWORD
                     name: Update Password
                     providerId: UPDATE_PASSWORD
                     enabled: true
                     defaultAction: false
                     priority: 30
                     config: {}
                   - alias: UPDATE_PROFILE
                     name: Update Profile
                     providerId: UPDATE_PROFILE
                     enabled: true
                     defaultAction: false
                     priority: 40
                     config: {}
                   - alias: VERIFY_EMAIL
                     name: Verify Email
                     providerId: VERIFY_EMAIL
                     enabled: true
                     defaultAction: false
                     priority: 50
                     config: {}
                   - alias: delete_account
                     name: Delete Account
                     providerId: delete_account
                     enabled: false
                     defaultAction: false
                     priority: 60
                     config: {}
                   - alias: webauthn-register
                     name: Webauthn Register
                     providerId: webauthn-register
                     enabled: true
                     defaultAction: false
                     priority: 70
                     config: {}
                   - alias: webauthn-register-passwordless
                     name: Webauthn Register Passwordless
                     providerId: webauthn-register-passwordless
                     enabled: true
                     defaultAction: false
                     priority: 80
                     config: {}
                   - alias: update_user_locale
                     name: Update User Locale
                     providerId: update_user_locale
                     enabled: true
                     defaultAction: false
                     priority: 1000
                     config: {}
                 browserFlow: browser
                 registrationFlow: registration
                 directGrantFlow: direct grant
                 resetCredentialsFlow: reset credentials
                 clientAuthenticationFlow: clients
                 dockerAuthenticationFlow: docker auth
                 attributes:
                   cibaBackchannelTokenDeliveryMode: poll
                   cibaAuthRequestedUserHint: login_hint
                   oauth2DevicePollingInterval: "5"
                   clientOfflineSessionMaxLifespan: "0"
                   clientSessionIdleTimeout: "0"
                   clientOfflineSessionIdleTimeout: "0"
                   cibaInterval: "5"
                   realmReusableOtpCode: "false"
                   cibaExpiresIn: "120"
                   oauth2DeviceCodeLifespan: "600"
                   parRequestUriLifespan: "60"
                   clientSessionMaxLifespan: "0"
                   adminEventsExpiration: ""
                 keycloakVersion: 20.0.5
                 userManagedAccessAllowed: false
                 clientProfiles:
                   profiles: []
                 clientPolicies:
                   policies: []
             EOF
             until curl -k --fail https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}')/realms/quarkus; do sleep 1; done
             sleep 30
             until oc get pod keycloak-0; do sleep 1; done
             oc exec -it keycloak-0 -- /opt/keycloak/bin/kcadm.sh create users --no-config --server http://localhost:8080 -r quarkus -s username=cooluser -s enabled=true -o --fields id,username --user admin --password $(oc extract secret/keycloak-initial-admin --keys password --to=- 2>&1 | grep -v ^#) --realm master     
             oc exec -it keycloak-0 -- /opt/keycloak/bin/kcadm.sh set-password --no-config --server http://localhost:8080 -r quarkus --username cooluser --new-password c00lp@ss --user admin --password $(oc extract secret/keycloak-initial-admin --keys password --to=- 2>&1 | grep -v ^#) --realm master
    workspaces:
    - name: manifest-dir
      workspace: shared
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: maven-task
spec:
  workspaces:
  - name: source
  params:
  - name: app_path
    description: Path to the application source code in the directory
    type: string
  steps:
  - name: build
    image: registry.access.redhat.com/ubi8/openjdk-17:1.16
    workingDir: $(workspaces.source.path)/$(params.app_path)
    script: mvn clean install
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: containerfile-task
spec:
  workspaces:
  - name: source
  params:
  - name: app_path
    description: Path to the application source code in the directory
    type: string
  steps:
  - name: build
    image: registry.access.redhat.com/ubi8/openjdk-17:1.16
    workingDir: $(workspaces.source.path)/$(params.app_path)
    script: |
            cat << EOF > Containerfile
            FROM registry.access.redhat.com/ubi8/openjdk-17-runtime:1.16

            ENV LANGUAGE='en_US:en'

            # We make four distinct layers so if there are application changes the library layers can be re-used
            COPY --chown=185 target/quarkus-app/lib/ /deployments/lib/
            COPY --chown=185 target/quarkus-app/*.jar /deployments/
            COPY --chown=185 target/quarkus-app/app/ /deployments/app/
            COPY --chown=185 target/quarkus-app/quarkus/ /deployments/quarkus/

            EXPOSE 8080
            USER 185
            ENV AB_JOLOKIA_OFF=""
            ENV JAVA_OPTS_APPEND="-Dquarkus.http.host=0.0.0.0 -Djava.util.logging.manager=org.jboss.logmanager.LogManager"
            ENV JAVA_APP_JAR="/deployments/quarkus-run.jar"
            WORKDIR /deployments

            ENTRYPOINT ["java", "-Djava.util.logging.manager=org.jboss.logmanager.LogManager", "-jar", "quarkus-run.jar"]
            EOF
    securityContext:
      runAsNonRoot: true
      runAsUser: 65532
---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
 name: deploy-coolstore
spec:
  params:
  - name: GIT_REPO
    type: string
    default: "https://github.com/jmontleon/eap-coolstore-monolith"
  - name: GIT_REVISION
    type: string
    default: quarkus-migration
  - name: IMAGE_NAME
    type: string
    default: "quarkus-coolstore"
  - name: IMAGE_REGISTRY
    type: string
    default: "image-registry.openshift-image-registry.svc:5000"
  workspaces:
  - name: shared

  tasks:
  - name: fetch-repository
    taskRef:
      name: git-clone
      kind: ClusterTask
    params:
    - name: url
      value: $(params.GIT_REPO)
    - name: revision
      value: $(params.GIT_REVISION)
    - name: subdirectory
      value: ""
    - name: deleteExisting
      value: "true"
    - name: sslVerify
      value: "false"
    workspaces:
    - name: output
      workspace: shared

  - name: write-application-properties
    taskRef:
      name: openshift-client
      kind: ClusterTask
    params:
    - name: SCRIPT
      value: |
             cat << EOF | oc create -f - ||:
             apiVersion: route.openshift.io/v1
             kind: Route
             metadata:
               labels:
                 app.kubernetes.io/managed-by: quarkus
                 app.kubernetes.io/version: 1.0.0-SNAPSHOT
                 app.openshift.io/runtime: quarkus
               name: coolstore
               namespace: $(context.pipelineRun.namespace)
             spec:
               port:
                 targetPort: http
               tls:
                 insecureEdgeTerminationPolicy: Allow
                 termination: edge
               to:
                 kind: Service
                 name: coolstore
                 weight: 100
               wildcardPolicy: None
             EOF
             sleep 3
             cat << EOF > src/main/resources/application.properties
             amqp-username=$(oc extract secret/rabbitmq-default-user --keys username --to=- 2>&1 | grep -v ^#)
             amqp-password=$(oc extract secret/rabbitmq-default-user --keys password --to=- 2>&1 | grep -v ^#)
             amqp-host=rabbitmq
             amqp-port=5672
             quarkus.log.level=FINEST
             quarkus.http.cors=true
             quarkus.http.cors.origins=http://localhost:8080,https://$(oc get route coolstore -o go-template='{{ .spec.host }}'),https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}'),http://$(oc get route coolstore -o go-template='{{ .spec.host }}')
             quarkus.datasource.db-kind=postgresql
             quarkus.datasource.username=cool
             quarkus.datasource.password=cooldb
             quarkus.datasource.jdbc.url=jdbc:postgresql://postgres:5432/coolstore
             %prod.quarkus.oidc.auth-server-url=https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}')/realms/quarkus
             quarkus.oidc.client-id=coolstore
             quarkus.oidc.tls.verification=none
             quarkus.oidc.credentials.jwt.issuer=https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}')/realms/quarkus
             quarkus.oidc.token.issuer=https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}')/realms/quarkus
             quarkus.hibernate-orm.database.generation=none
             quarkus.hibernate-orm.log.sql=false
             quarkus.hibernate-orm.log.format-sql=true
             quarkus.devservices.enabled=false
             EOF
             cat src/main/resources/application.properties
    runAfter:
    - fetch-repository
    workspaces:
    - name: manifest-dir
      workspace: shared

  - name: write-keycloak-json
    taskRef:
      name: openshift-client
      kind: ClusterTask
    workspaces:
    - name: manifest-dir
      workspace: shared
    runAfter:
    - write-application-properties
    params:
    - name: SCRIPT
      value: |
             cat << EOF > src/main/resources/META-INF/resources/keycloak.json 
             {
               "realm": "quarkus",
               "auth-server-url": "https://$(oc get route -l app=keycloak -o go-template='{{ (index .items 0).spec.host }}')/",
               "ssl-required": "external",
               "resource": "ui",
               "public-client": true,
               "confidential-port": 0
             }
             EOF

  - name: build
    taskRef:
      name: maven-task
      kind: Task
    params:
    - name: app_path
      value: ""
    runAfter:
    - write-keycloak-json
    workspaces:
    - name: source
      workspace: shared

  - name: write-containerfile
    taskRef:
      name: containerfile-task
      kind: Task
    params:
    - name: app_path
      value: ""
    runAfter:
    - build
    workspaces:
    - name: source
      workspace: shared

  - name: build-image
    taskRef:
      name: buildah
      kind: ClusterTask
    params:
    - name: IMAGE
      value: $(params.IMAGE_REGISTRY)/$(context.pipelineRun.namespace)/$(params.IMAGE_NAME):latest
    - name: DOCKERFILE
      value: Containerfile
    - name: CONTEXT
      value: ""
    - name: TLSVERIFY
      value: "false"
    runAfter:
    - write-containerfile
    workspaces:  
    - name: source
      workspace: shared

  - name: deploy-coolstore
    taskRef:
      name: openshift-client
      kind: ClusterTask
    workspaces:
    - name: manifest-dir
      workspace: shared
    runAfter:
    - build-image
    params:
    - name: SCRIPT
      value: |
             cat << EOF | oc create -f - ||: 
             ---
             apiVersion: batch/v1
             kind: Job
             metadata:
               name: coolstore-flyway-init
             spec:
               completionMode: NonIndexed
               template:
                 metadata: {}
                 spec:
                   containers:
                     - env:
                         - name: JAVA_APP_JAR
                           value: /deployments/quarkus-run.jar
                         - name: QUARKUS_FLYWAY_ENABLED
                           value: "true"
                         - name: QUARKUS_INIT_AND_EXIT
                           value: "true"
                       image: image-registry.openshift-image-registry.svc:5000/$(context.pipelineRun.namespace)/quarkus-coolstore:latest
                       name: coolstore-flyaway-init
                   restartPolicy: OnFailure
             ---
             apiVersion: apps.openshift.io/v1
             kind: DeploymentConfig
             metadata:
               annotations:
               labels:
                 app: coolstore
                 app.kubernetes.io/deploy-coolstore-prereqsmanaged-by: quarkus
                 app.kubernetes.io/version: 1.0.0-SNAPSHOT
                 app.openshift.io/runtime: quarkus
               name: coolstore
               namespace: $(context.pipelineRun.namespace)
             spec:
               replicas: 1
               selector:
                 app.kubernetes.io/version: 1.0.0-SNAPSHOT
               strategy:
                 activeDeadlineSeconds: 21600
                 resources: {}
                 rollingParams:
                   intervalSeconds: 1
                   maxSurge: 25%
                   maxUnavailable: 25%
                   timeoutSeconds: 600
                   updatePeriodSeconds: 1
                 type: Rolling
               template:
                 metadata:
                   creationTimestamp: null
                   labels:
                     app: coolstore
                     app.kubernetes.io/managed-by: quarkus
                     app.kubernetes.io/version: 1.0.0-SNAPSHOT
                     app.openshift.io/runtime: quarkus
                 spec:
                   containers:
                   - env:
                     - name: KUBERNETES_NAMESPACE
                       valueFrom:
                         fieldRef:
                           apiVersion: v1
                           fieldPath: metadata.namespace
                     - name: QUARKUS_FLYWAY_ENABLED
                       value: "false"
                     - name: JAVA_APP_JAR
                       value: /deployments/quarkus-run.jar
                       image: image-registry.openshift-image-registry.svc:5000/$(context.pipelineRun.namespace)/quarkus-coolstore:latest
                     imagePullPolicy: Always
                     name: coolstore
                     ports:
                     - containerPort: 8080
                       name: http
                       protocol: TCP
                     resources: {}
                     terminationMessagePath: /dev/termination-log
                     terminationMessagePolicy: File
                   dnsPolicy: ClusterFirst
                   restartPolicy: Always
                   schedulerName: default-scheduler
                   securityContext: {}
                   terminationGracePeriodSeconds: 30
               test: false
               triggers:
               - type: ConfigChange
               - imageChangeParams:
                   automatic: true
                   containerNames:
                   - coolstore
                   from:
                     kind: ImageStreamTag
                     name: quarkus-coolstore:latest
                     namespace: $(context.pipelineRun.namespace)
                 type: ImageChange
             ---
             apiVersion: v1
             kind: Service
             metadata:
               labels:
                 app: coolstore
                 app.kubernetes.io/managed-by: quarkus
                 app.kubernetes.io/version: 1.0.0-SNAPSHOT
                 app.openshift.io/runtime: quarkus
               name: coolstore
               namespace: $(context.pipelineRun.namespace)
             spec:
               ports:
               - name: http
                 port: 80
                 protocol: TCP
                 targetPort: 8080
               selector:
                 app: coolstore
               sessionAffinity: None
               type: ClusterIP
             ---
             EOF
